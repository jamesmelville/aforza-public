function runAction(i){let f=new Array,n=new Array,u=i.data.record,c=new Map,s=new Map;i.data.related.PricebookEntry.forEach(t=>{t.Pricebook2Id==u.Pricebook2Id&&c.set(t.Product2Id,t)}),i.data.related.OrderItem.forEach(t=>{if(t.aforza__Promotion__c)if(c.has(t.Product2Id)||n.push("Product "+t.Product2Id+" missing from Pricebook."),t.Quantity=t.OriginalQuantity__c,s.has(t.Product2Id)){let e=s.get(t.Product2Id),r=0;for(;r<e.length&&t.UnitPrice<e[r].UnitPrice;)r++;e.splice(r,0,t)}else s.set(t.Product2Id,new Array(t))});for(let t=1;t<11;t++){let e=u["MissingProduct"+t+"__c"],r=u["MissingQuantity"+t+"__c"];if(e&&!s.has(e))n.push("Missing Product "+t+" is not included in a Promotion in this order. Please check for the correct product.");else if(e&&!r)n.push("Please enter a quantity for Missing Product "+t+".");else if(e&&r){let l=s.get(e),a=r,d=0;for(;a>0&&d<l.length;){let o=l[d];o.Quantity>=a?(o.Quantity=o.Quantity-a,a=0):(a=a-o.Quantity,o.Quantity=0),d++}a>0?n.push("Missing Quantity exceeds ordered promotional quantity for Missing Product "+t+"."):f.push("Promotional Quantity(ies) adjusted for Missing Product "+t+".")}}let P=0;return i.data.related.OrderItem.forEach(t=>{if(c.has(t.Product2Id)){let e=c.get(t.Product2Id);if(e.Name!="Tax"){if(t.aforza__Promotion__c&&e.aforza__Tax_Percent__c){let r=t.Quantity*t.UnitPrice*e.aforza__Tax_Percent__c;r=Math.round(r+Number.EPSILON)/100,t.aforza__Tax__c=r}P+=t.aforza__Tax__c}}}),i.data.related.OrderItem.forEach(t=>{c.has(t.Product2Id)&&c.get(t.Product2Id).Name=="Tax"&&(t.UnitPrice=P)}),n.length>0?(i.data.error=n.join(`\r
`),i.data.updateDeviceData=!1,i.data.reprice=!1,i.data.blockExecution=!0):(i.data.message=f.join(`\r
`),i.data.updateDeviceData={Order:!0,OrderItem:!0},i.data.reprice=!1),i}
